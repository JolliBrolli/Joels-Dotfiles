#!/bin/zsh

# --- Configuration ---
# Get the name of the current directory to use as the project name
PROJECT_NAME=$(basename "$(pwd)")
BUILD_DIR="build" # Kept for the exclusion logic in 'find'
# Define standard source and header directories
SRC_DIR="src"
INCLUDE_DIR="include"
MAIN_CPP_CONTENT="#include <iostream>\n\nint main() {\n\tstd::cout << \"Hello from ${PROJECT_NAME}!\" << std::endl;\n\treturn 0;\n}"

# --- Step 0: Create standard directories if they don't exist ---
echo "üìÅ Checking/Creating standard project directories..."
# Create src/
if [[ ! -d ${SRC_DIR} ]]; then
    mkdir ${SRC_DIR}
    echo "  -> Created ${SRC_DIR}/"
fi
# Create include/
if [[ ! -d ${INCLUDE_DIR} ]]; then
    mkdir ${INCLUDE_DIR}
    echo "  -> Created ${INCLUDE_DIR}/"
fi
echo "‚úÖ Directories ensured."

# --- Step 1: Generate CMakeLists.txt and main.cpp if they don't exist ---
if [[ ! -f CMakeLists.txt ]]; then
    echo "‚öôÔ∏è  Generating CMakeLists.txt..."

    # Find all .cpp files recursively (excluding the build directory), now looking inside src/
    # Note: The script now looks for files relative to the current directory, e.g., "src/main.cpp"
    SOURCE_FILES=($(find . -maxdepth 5 -name "*.cpp" -not -path "./${BUILD_DIR}/*" -printf "%P\n" | sort))

    # If no .cpp files are found, assume a new project and add src/main.cpp
    if [[ -z $SOURCE_FILES ]]; then
        # IMPORTANT: Default file is now placed in the src/ directory
        SOURCE_FILES=("${SRC_DIR}/main.cpp")
    fi

    # Format the source file list for the CMake file, handling the first file cleanly
    SOURCE_LIST_INDENTED=""
    IS_FIRST=true
    for file in $SOURCE_FILES; do
        if $IS_FIRST; then
            SOURCE_LIST_INDENTED+=" ${file}"
            IS_FIRST=false
        else
            SOURCE_LIST_INDENTED+="\n    ${file}"
        fi
    done

    # Generate the CMakeLists.txt content using the formatted list
    # NOTE: The target_include_directories and source list are updated to reflect the new structure.
    cat << EOF > CMakeLists.txt
# CMakeLists.txt - Auto-generated by setup script

# 1. Minimum required CMake version
cmake_minimum_required(VERSION 3.15)

# 2. Define the project name and language
project(${PROJECT_NAME} LANGUAGES CXX)

# 3. Set C++ Standard and disable extensions
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED True)
set(CMAKE_CXX_EXTENSIONS False)

# 4. Define the executable target and source files.
# THIS MUST COME BEFORE target_compile_options
add_executable(${PROJECT_NAME}${SOURCE_LIST_INDENTED}
)

# 5. Set strict compiler warnings (equivalent to VS /W4 and /WX)
target_compile_options(${PROJECT_NAME} PRIVATE
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wall>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wextra>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wconversion>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wsign-conversion>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Werror>
)

# 6. Optional: Add a public include directory (updated to use INCLUDE_DIR)
target_include_directories(${PROJECT_NAME}
    PRIVATE
    \${CMAKE_SOURCE_DIR}/${INCLUDE_DIR}
)

# 7. Optional: Set a common output directory
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY \${CMAKE_BINARY_DIR}/bin)
EOF

    echo "‚úÖ CMakeLists.txt created with project name: **${PROJECT_NAME}**."
fi

# Create a default main.cpp in the SRC_DIR if it doesn't exist and the generated CMakeLists.txt refers to it
if [[ ! -f ${SRC_DIR}/main.cpp ]] && grep -q "${SRC_DIR}/main.cpp" CMakeLists.txt; then
    # Check if 'src/main.cpp' is the only file, to avoid overwriting existing projects
    if [[ ${#SOURCE_FILES} -eq 1 ]] && [[ ${SOURCE_FILES[1]} = "${SRC_DIR}/main.cpp" ]]; then
        echo "üìÑ Creating default ${SRC_DIR}/main.cpp..."
        echo -e "$MAIN_CPP_CONTENT" > ${SRC_DIR}/main.cpp
    fi
fi

echo "‚ú® Project setup complete. You can now run 'cmake -S . -B build' and 'cmake --build build' yourself."

#!/bin/zsh

# --- Configuration ---
# Get the name of the current directory to use as the project name
PROJECT_NAME=$(basename "$(pwd)")
BUILD_DIR="build" # Kept for the exclusion logic in 'find'
MAIN_CPP_CONTENT="#include <iostream>\n\nint main() {\n\tstd::cout << \"Hello from ${PROJECT_NAME}!\" << std::endl;\n\treturn 0;\n}"

# --- Step 1: Generate CMakeLists.txt and main.cpp if they don't exist ---
if [[ ! -f CMakeLists.txt ]]; then
    echo "âš™ï¸  Generating CMakeLists.txt..."

    # Find all .cpp files recursively (excluding the build directory)
    SOURCE_FILES=($(find . -maxdepth 5 -name "*.cpp" -not -path "./${BUILD_DIR}/*" -printf "%P\n" | sort))

    # If no .cpp files are found, assume a new project and add main.cpp
    if [[ -z $SOURCE_FILES ]]; then
        SOURCE_FILES=("main.cpp")
    fi

    # Format the source file list for the CMake file, handling the first file cleanly
    SOURCE_LIST_INDENTED=""
    IS_FIRST=true
    for file in $SOURCE_FILES; do
        if $IS_FIRST; then
            SOURCE_LIST_INDENTED+=" ${file}"
            IS_FIRST=false
        else
            SOURCE_LIST_INDENTED+="\n    ${file}"
        fi
    done

    # Generate the CMakeLists.txt content using the formatted list
    cat << EOF > CMakeLists.txt
# CMakeLists.txt - Auto-generated by setup script

# 1. Minimum required CMake version
cmake_minimum_required(VERSION 3.15)

# 2. Define the project name and language
project(${PROJECT_NAME} LANGUAGES CXX)

# 3. Set C++ Standard and disable extensions
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED True)
set(CMAKE_CXX_EXTENSIONS False)

# 4. Define the executable target and source files.
# THIS MUST COME BEFORE target_compile_options
add_executable(${PROJECT_NAME}${SOURCE_LIST_INDENTED}
)

# 5. Set strict compiler warnings (equivalent to VS /W4 and /WX)
target_compile_options(${PROJECT_NAME} PRIVATE
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wall>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wextra>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wconversion>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Wsign-conversion>
    \$<\$<COMPILE_LANGUAGE:CXX>:-Werror>
)

# 6. Optional: Add a public include directory
target_include_directories(${PROJECT_NAME}
    PRIVATE
    \${CMAKE_SOURCE_DIR}/include
)

# 7. Optional: Set a common output directory
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY \${CMAKE_BINARY_DIR}/bin)
EOF

    echo "âœ… CMakeLists.txt created with project name: **${PROJECT_NAME}**."
fi

# Create a default main.cpp if it doesn't exist and the generated CMakeLists.txt refers to it
if [[ ! -f main.cpp ]] && grep -q "main.cpp" CMakeLists.txt; then
    # Check if 'main.cpp' is the only file, to avoid overwriting existing projects
    if [[ ${#SOURCE_FILES} -eq 1 ]] && [[ ${SOURCE_FILES[1]} = "main.cpp" ]]; then
        echo "ðŸ“„ Creating default main.cpp..."
        echo -e "$MAIN_CPP_CONTENT" > main.cpp
    fi
fi

echo "âœ¨ Project setup complete. You can now run 'cmake -S . -B build' and 'cmake --build build' yourself."
